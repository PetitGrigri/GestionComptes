{% extends "FGSGestionComptesBundle::layout.html.twig" %}
{% set date_plus_1_mois 	= date|date_modify("+1 month") %}
{% set date_moins_1_mois 	= date|date_modify("-1 month") %}

{% set compteur_mouvements_effectifs	= 0 %}
{% set compteur_mouvements_planifies	= 0 %}

{% block title %}Visualisation des données d'un compte{% endblock %}

{% block modal %}
<!-- Boite de dialogue -->
<div class="modal" id="date">
	<div class="modal-dialog">
		<div class="modal-content">
		</div>
	</div>
</div>
{% endblock %}

{% block contenu %}
<!-- Titre (image, nom et date du mois en cours) -->
<div class='row'>
	<div class="col-md-1 col-xs-2" class="height: 38px;">
		<img src="{{ asset('bundles/fgsgestioncomptes/'~compte.banque.urlImage) }}" style="height: 32px; margin-top: 22px; margin-bottom:12" />
	</div>
	<div class="col-md-11 col-xs-10">
		<h1>{{ compte.nom }} ({{ date|localizeddate('full','none',null, null, 'MMMM YYYY') }})</h1>
	</div>
</div>

<!--  Totaux (Revenus, Totaux, Dépenses)-->
<div class='row'>
	<!--  Revenus -->
	<div class='col-md-4'>
		<div class='gestion-compte-info gestion-compte-info-revenu'>
			<div class='col-md-6'>
				<h3 class='gestion-compte-info-titre'>Revenu à ce jour</h3>
				<div class='gestion-compte-info-contenu'>{{ totalRevenuNotPlanified }} €</div>
			</div>
			<div class='col-md-6'>
				<h3 class='gestion-compte-info-titre'>Revenu à venir</h3>
				<div class='gestion-compte-info-contenu'>{{ totalRevenuPlanified }} €</div>
			</div>
		</div>
	</div>
	
	<!--  Totaux -->
	<div class='col-md-4'>
		<div class='gestion-compte-info gestion-compte-info-total'>
			<div class='col-md-6'>
				<h3 class='gestion-compte-info-titre'>Total à ce jour</h3>
				<div class='gestion-compte-info-contenu'>{{ compte.montantActuel }} €</div>
			</div>
			<div class='col-md-6'>
				<h3 class='gestion-compte-info-titre'>Total planifié</h3>
				<div class='gestion-compte-info-contenu'>{{ compte.montantActuel + totalRevenuPlanified + totalDepensePlanified }} €</div>
			</div>
		</div>
	</div>
	
	<!--  Dépenses -->
	<div class='col-md-4'>
		<div class='gestion-compte-info gestion-compte-info-depense'>
			<div class='col-md-6'>
				<h3 class='gestion-compte-info-titre'>Dépense à ce jour</h3>
				<div class='gestion-compte-info-contenu'>{{ totalDepenseNotPlanified | abs }} €</div>
			</div>
			<div class='col-md-6'>
				<h3 class='gestion-compte-info-titre'>Dépense à venir</h3>
				<div class='gestion-compte-info-contenu'>{{ totalDepensePlanified | abs }} €</div>
			</div>
		</div>
	</div>
</div>

{% if compte.mouvementFinanciers is not empty %}
	<div class='row'>
		<!-- visualisations des mouvements financiers  -->
		<div class='col-md-9'>
			<ul class="nav nav-tabs nav-justified">
				<li class="active"><a href="#operations" data-toggle="tab">Opérations </a></li>
				<li><a href="#operations_planifiees" data-toggle="tab">Opérations à venir </a></li>
			</ul>
			<div class="tab-content">
				<!-- Mouvements financiers effectifs -->
				<div class="tab-pane active" id="operations">
					<table class="table table-striped ">
						<thead>
							<tr>
								<th></th>
								<th>
									Date
								</th>
								<th>
									Libellé
								</th>
								<th>
									Catégorie
								</th>
								<th class="text-right">
									Montant
								</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{% for mouvementFinancier in compte.mouvementFinanciers %}
								{% if mouvementFinancier.isPlanified == false %}
									{% set compteur_mouvements_effectifs = compteur_mouvements_effectifs + 1 %}
									<tr>
										<td>{% if mouvementFinancier.checkBanque%}<a href="{{ path('fgs_gestion_comptes_check_mouvement_financier', {'id':mouvementFinancier.id}) }}" class='btn btn-xs text-success'><span class='glyphicon glyphicon-thumbs-up'></span></a>{% else %}<a href="{{ path('fgs_gestion_comptes_check_mouvement_financier', {'id':mouvementFinancier.id}) }}" class='btn btn-xs text-muted'><span class='glyphicon glyphicon-thumbs-down'></span></a>{% endif %}</td>
										<td>{{ mouvementFinancier.date|date("d/m/Y") }}</td>
										<td>{% if mouvementFinancier.commentaire %}<span class='glyphicon glyphicon-tag' data-toggle='tooltip' title='{{ mouvementFinancier.commentaire }}'></span> {% endif %}{{ mouvementFinancier.libelle }}</td>
										<td><p class='label {{ mouvementFinancier.montant > 0 ? 'label-success':'label-warning' }} categorie-mf'><span class=' text-center glyphicon {{ mouvementFinancier.categorieMouvementFinancier.icone }}'></span> {{ mouvementFinancier.categorieMouvementFinancier.libelle }}</p></td>
										<td class="text-right">{{ mouvementFinancier.montant|localizedcurrency('EUR') }}</td>
										<td class='text-right'>
											<a href='{{ path('fgs_gestion_comptes_modifier_mouvement_financier', {'id':mouvementFinancier.id}) }}' class='btn btn-info btn-xs'><span class='glyphicon glyphicon-pencil'></span></a> 
											<a href='{{ path('fgs_gestion_comptes_supprimer_mouvement_financier', {'id':mouvementFinancier.id}) }}' class='btn btn-danger btn-xs'><span class='glyphicon glyphicon-remove'></span></a>
										</td>
									</tr>
								{% endif %}
							{% endfor %}
						</tbody>
						<caption style="caption-side: bottom; text-align:right;">{{ 'mouvement.valeur'|transchoice(compteur_mouvements_effectifs) }} </caption>
					</table>
				</div>
				
				<!-- Mouvements financiers planifiées -->
				<div class="tab-pane" id="operations_planifiees">
					<table class="table table-striped ">
						<thead>
							<tr>
								<th></th>
								<th>
									Date
								</th>
								<th>
									Libellé
								</th>
								<th>
									Catégorie
								</th>
								<th class="text-right">
									Montant
								</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{% for mouvementFinancier in compte.mouvementFinanciers %}
								{% if mouvementFinancier.isPlanified == true %}
									{% set compteur_mouvements_planifies = compteur_mouvements_planifies + 1 %}
									<tr>
										<td>{% if mouvementFinancier.checkBanque%}<a href="{{ path('fgs_gestion_comptes_check_mouvement_financier', {'id':mouvementFinancier.id}) }}" class='btn btn-xs text-success'><span class='glyphicon glyphicon-thumbs-up'></span></a>{% else %}<a href="{{ path('fgs_gestion_comptes_check_mouvement_financier', {'id':mouvementFinancier.id}) }}" class='btn btn-xs text-muted'><span class='glyphicon glyphicon-thumbs-down'></span></a>{% endif %}</td>
										<td>{{ mouvementFinancier.date|date("d/m/Y") }}</td>
										<td>{% if mouvementFinancier.commentaire %}<span class='glyphicon glyphicon-tag' data-toggle='tooltip' title='{{ mouvementFinancier.commentaire }}'></span> {% endif %}{{ mouvementFinancier.libelle }}</td>
										<td><p class='label {{ mouvementFinancier.montant > 0 ? 'label-success':'label-warning' }} categorie-mf'><span class=' text-center glyphicon {{ mouvementFinancier.categorieMouvementFinancier.icone }}'></span> {{ mouvementFinancier.categorieMouvementFinancier.libelle }}</p></td>
										<td class="text-right">{{ mouvementFinancier.montant|localizedcurrency('EUR') }}</td>
										<td class='text-right'>
											<a href='{{ path('fgs_gestion_comptes_modifier_mouvement_financier', {'id':mouvementFinancier.id}) }}' class='btn btn-info btn-xs'><span class='glyphicon glyphicon-pencil'></span></a> 
											<a href='{{ path('fgs_gestion_comptes_supprimer_mouvement_financier', {'id':mouvementFinancier.id}) }}' class='btn btn-danger btn-xs'><span class='glyphicon glyphicon-remove'></span></a>
										</td>
									</tr>
								{% endif %}
							{% endfor %}
						</tbody>
						<caption style="caption-side: bottom; text-align:right;">{{ 'mouvement_planifie.valeur'|transchoice(compteur_mouvements_planifies) }} </caption>
					</table>
				</div>
			</div>
		</div>
	
		
		<div class='col-md-3'>
			<div class="panel panel-danger">
				<div class="panel-heading">
					Répartition Dépenses
				</div>
				<div class="panel-body">
					<div>
						<canvas id="canvas-depense" style="width: 100%; height: auto;"/>
					</div>
					<ul class='list-group' >
						{% for totalCategorie in totauxParCategorie %}
							{% if totalCategorie['total'] < 0  %}
								<li class='list-group-item' style='border:none;'>{{ totalCategorie['libelle_categorie'] }} <span class="badge pull-right">{{ totalCategorie['total']|abs  }} €</span></li>
							{% endif %}
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	</div>
{% else %}
	<p class='well well-sm' style='background-color:#f9f9f9;'>Aucune transaction n'a encore été réalisé sur ce compte ce mois ci.<p>
{% endif %}

<nav>
	<ul class="pager">
		<li class=""><a href="{{ path('fgs_gestion_comptes_visualiser_mouvement_financier_compte_mois', {'id':id, 'annee':date_moins_1_mois|date('Y'),'mois':date_moins_1_mois|date('m')}) }}"><span aria-hidden="true">&larr;</span> Mois précédent</a></li>
		<li class=""id="mois_annee_en_cours"><a href='{{ path('fgs_gestion_comptes_visualiser_mouvement_financier_compte_mois', {'id':id}) }}'><span class='glyphicon glyphicon-calendar'></span></a></li>
		<li class=""><a href="{{ path('fgs_gestion_comptes_visualiser_mouvement_financier_compte_mois', {'id':id, 'annee':date_plus_1_mois|date('Y'),'mois':date_plus_1_mois|date('m')}) }}">Mois suivant <span aria-hidden="true">&rarr;</span></a></li>
	</ul>
</nav>

{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="{{ asset('bundles/fgsgestioncomptes/css/iconset/daily-life.css') }}">
<link rel="stylesheet" href="{{ asset('bundles/fgsgestioncomptes/css/Mouvements/visualiser_mouvements_compte_mois.css') }}">
<link rel="stylesheet" href="{{ asset('bundles/fgsbootstrap/css/datepicker3.css') }}">
<style>
.datepicker.dropdown-menu th,
.datepicker.datepicker-inline th,
.datepicker.dropdown-menu td,
.datepicker.datepicker-inline td {
  padding: 4px 15px;
}
.modal-content
{
	margin-right: auto;
	margin-left: auto;
	width: 342px;
}
#date .modal-dialog
{
	z-index:9999;
}
.table
{
	border: 1px solid #ddd;
	border-top:0px;
}
</style>
{% endblock %}


{% block javascripts %}
{{ parent() }}
<script src="{{ asset('bundles/fgsgestioncomptes/js/Chart.js') }}"></script>
<script src="{{ asset('bundles/fgsbootstrap/js/bootstrap-datepicker.js') }}"></script>
<script src="{{ asset('bundles/fgsbootstrap/js/locales/bootstrap-datepicker.fr.js') }}"></script>
<script>

$(function () {
  $('[data-toggle="tooltip"]').tooltip();
})



//sélection du mois à afficher
$('#mois_annee_en_cours').datepicker({
    format: "MM yyyy",
    minViewMode: 1,
    language: "fr",
    calendarWeeks: true,
    autoclose: true,
    orientation: "bottom"
}).on('changeDate',function(e){
	var date_selectionnee = $('#mois_annee_en_cours').datepicker('getDate');
	var page_lien = $('#mois_annee_en_cours a').attr('href');
	
	
	window.location = page_lien+'/'+date_selectionnee.getFullYear()+'/'+(date_selectionnee.getMonth()+1);
});

$('#mois_annee_en_cours').click(function(event){
	event.preventDefault();
});


//graphique
var dataCanvasDepense = [
	{% for totalCategorie in totauxParCategorie %}
		{% if totalCategorie['total'] < 0  %}
		{	
			value: {{ totalCategorie['total']|abs  }},
			color:"#F7464A",
			highlight: "#FF5A5E",
			label: "{{ totalCategorie['libelle_categorie'] }}"
		}
		{% if loop.last == false %},{% endif %}
		{% endif %}
	{% endfor %}
];

var confCanvas = {responsive : true};

window.onload = function(){
	var ctx = document.getElementById("canvas-depense").getContext("2d");
	window.myDoughnut = new Chart(ctx).Doughnut(dataCanvasDepense, confCanvas);

};


</script>
{% endblock %}
